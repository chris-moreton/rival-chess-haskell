module Util.Zobrist where

import Types
    ( Mover(Black, White),
      Piece(King, Pawn, Knight, Bishop, Rook, Queen),
      Position(mover, enPassantSquare) )
import Data.Vector as V ( Vector, fromList, (!) )
import Search.Evaluate ( pieceOnSquare )
import Data.Bits (xor)
import Data.Maybe ( isNothing )

startZobristValue :: Int
startZobristValue = 1427869295504964227
whitePawnZobristSquares :: V.Vector Int
whitePawnZobristSquares = V.fromList [2757563266877852572, 6372315729141069125, 6531282879677255786, 6217800311556484852, 4028653356764102261, 7173945121263241432, 3140540760890330300, 186456652255508025, 4326822066600281601, 1676275713585176313, 994786814496869094, 7266780370156599753, 1993832195284356489, 8906581877710625494, 13143720840670621, 4898713441463880900, 2606168633944391863, 1278377858051695283, 1882005865304517078, 3567997896755807464, 2122005311604240155, 2319007812912636961, 4341526477626483922, 4112961148281161054, 1873977493594566140, 305729391848946031, 1737015787209404385, 2237900801421661035, 3194938434899723208, 6533797044794123108, 53098511802011562, 3081966774796706547, 1696652368246260792, 2862724276072767459, 1287517088619610318, 2602374675812111264, 4756084200418510689, 5276272864338057212, 8687878729112386221, 4135797612500512402, 5514543711318410338, 5560689077408854053, 2256144847160470449, 4417513483083909270, 3035972007832032975, 7368920397373182932, 6920167683995549487, 6247308382891571962, 5676121683487873905, 9175320351448874372, 5910720470467824693, 907420310966211028, 6716488881646089174, 5928558823587778993, 5915781820118628492, 39463936643324408, 5811376027078466953, 6523428793023374251, 5956533780815835809, 3641790615902344529, 7353877805870994894, 939029069031068496, 8125675455391727839, 4589414129899697073] :: V.Vector Int
whiteKnightZobristSquares :: V.Vector Int
whiteKnightZobristSquares = V.fromList [706413976754998224, 5237446959228702633, 4502343349913478046, 4284922253622685935, 794556809418481704, 6752480058157658297, 5122029621984886652, 6882057774524096198, 6541274272475607484, 1574242302337288143, 111900223082258093, 6631459239802814568, 526646747656935902, 3357192273790967373, 3598688189568699342, 5546366303086541876, 1726594687531813407, 4987647731489328978, 3580842832605597181, 7743075973487833223, 2776180945377874707, 6742207452261577653, 3524831375196424107, 7614586915232374818, 6115393728617541508, 1125662212014421892, 231458207239155535, 2885178576595681658, 2690121602411998221, 3533102710711774971, 7740701900047567421, 1255503606430395821, 8399862489813273836, 1439234334975020321, 4763417158037960862, 4977818468183857538, 4984644494470203422, 4351639087268581437, 2899815003034077612, 9108461806324676569, 5172153358648562244, 2597331834528227009, 6109954286982553472, 2912933226757411468, 7640543903334245893, 2844971232928040881, 2279605498837990134, 3463731465304653534, 76901528508813291, 6280005240992472692, 3260455415836512746, 4131337061747131489, 1402852472918327774, 5102723766602758144, 2949259100454305372, 1944378517589392750, 6606049276124010842, 4945875818949224017, 6463697859664636677, 4563130144202493590, 1130798484264037885, 4668778934824795676, 4808737661328924273, 3266976802810975809] :: V.Vector Int
whiteBishopZobristSquares :: V.Vector Int
whiteBishopZobristSquares = V.fromList [3526724629200970276, 48526046699759754, 8167123585693394048, 7126737563418726157, 3884530645993766909, 7040664248638881451, 5837271942644127481, 3616987892652505963, 4083408828443113930, 5348706984051486926, 7306942631434919894, 7788911306385470611, 1920797669047726069, 5767621404457930932, 4939777947758921246, 6828298627902150213, 4582988639121771633, 2721189556933358956, 496370117853838243, 8143452293799687270, 6002576524389228294, 8411950427977459053, 1823534971628121651, 3983150712003752658, 2783514311632729460, 9094688704651908402, 1682895755282384617, 3213042356150788443, 6174516486991242124, 5429085076595783743, 3381254759730602595, 5479816068083974802, 8204697593884991320, 6347530531368040414, 4490397025128192141, 8407408328672604196, 5997021339967186156, 1947076232270972848, 6201620772051583256, 7744342598707609147, 1939499042085219765, 6834867949355847005, 5596041422517147349, 6345497246432346170, 1231538645575753339, 8235430625516224931, 2583608123937963550, 6795223553357527787, 6281788933568863916, 2216591880958825895, 1723055813825809089, 8462832260593510096, 3096213975196258774, 7182992208714122364, 5137375666796102465, 4641310499159706793, 8255850789418445260, 3895969293116932325, 202121942194941618, 3001032906906561674, 4817543641936854517, 2933098853597619575, 1729709981808028074, 2905624112688754045] :: V.Vector Int
whiteQueenZobristSquares :: V.Vector Int
whiteQueenZobristSquares = V.fromList [4269252335467993961, 8855045279702453407, 7395403973528249356, 4022410470817470542, 7372074797706027983, 5872608254904647593, 5065301752116643350, 7688499207936066304, 3218757409228525372, 4651989491941495962, 6503996956873938409, 489241169476201417, 8609457659388063253, 2646243653538414237, 4447266732656982996, 193915167707836644, 4529961767168652, 4737883173481870005, 6302424584209810931, 338657460727683711, 1563300542944841483, 5327156014778687932, 2870495655378563278, 5608507905247097283, 3590216443108144923, 2875661783927563348, 7124359522283911602, 8428430503568743857, 4767059299910687386, 2590273633516971606, 4761562871388918166, 2652204195911211977, 8826896887974165415, 1065176361428595232, 9157163046871280177, 4502759812759664448, 5726299958902904109, 530072053618769216, 895846526316524618, 467937357922516750, 8602063605459535850, 6719205568977338381, 8583693595904718437, 4153004816965705917, 5966796638923899027, 1032034806207365317, 1307506363588584492, 3712735712719939276, 4343944053518729075, 1282423760452505319, 173424631240495461, 8381780405369056950, 2199954421593380451, 444917898291442463, 6480926845079875269, 7537216052377744129, 3774733988261462373, 7499074026023255496, 7607843325131718492, 6093993311717792743, 2331685763872572587, 4352876686499200149, 4235202761664779967, 5895241459534232072] :: V.Vector Int
whiteRookZobristSquares :: V.Vector Int
whiteRookZobristSquares = V.fromList [5482059440352445727, 7956339969058211934, 4954060434318501117, 8115995729820763036, 5721347636312841333, 2551590848249369923, 8761151027090434770, 1450048539819847742, 809275049474077988, 3913411587935094951, 7099828467142482864, 1026992368184896896, 3925751325938633014, 9074419762504123157, 1246437869013631664, 7378047233887314923, 474504446116046695, 681026732928034876, 7503100584678545241, 5144675340194602534, 3281803653846062286, 4706541021557088044, 6352787564453770705, 3307736953582204212, 925057422725221765, 4328643808080894957, 1442583851450410906, 437666655235918844, 7750516601172680244, 7066318828270012948, 8430491571929385137, 9058449950227869823, 5757510486901178080, 7279843450518321304, 43127866548369872, 7801665669407941225, 869472628767054139, 4455912880072542546, 4776599164076577267, 4995651884202018016, 9205339851548284274, 2991217360619359484, 8113533920899574669, 2725531378807444516, 1903209836595839133, 869792416915504714, 2624383920180508576, 7463622451271065457, 4031369777553205636, 8198744696199806783, 6209155299517931176, 7716991479317077036, 8552324997505406292, 5190792594819684254, 5405583483881399091, 1412560298191341700, 103316124955288142, 2570802615516381813, 2742678712837978301, 4736800798767083968, 4689925640499760316, 2011713206560716592, 7698839976705558703, 2101693932821614576] :: V.Vector Int
whiteKingZobristSquares :: V.Vector Int
whiteKingZobristSquares = V.fromList [9134090328332492302, 5263125285456236617, 2002707346266872506, 8457109776747425942, 6277262185843779334, 1261513154258218264, 743595506557340024, 5118696197521219182, 6389320403900203415, 4792717765137656718, 4590599381035109524, 4633000749212460643, 8853302209228134548, 829933116792773481, 7454206074684803970, 1331564509239791452, 2434809458655800162, 7528690117223614777, 7112175028828574739, 889991979395197613, 3510095911311826305, 6167459476425399399, 8472822513950460484, 878660785199353768, 4718343879738261675, 5624193844673635964, 5799899023464378991, 1093009618003491558, 4513119637856023694, 2754385592750650280, 3524340711222428242, 1204651937704060576, 2768034571782041027, 5845313009030790673, 2379638552628418965, 705221492190164429, 5692332855001729224, 5134048240937163093, 7862354069605444682, 4652522373255046423, 6562611794933572479, 7225846535560570563, 6798374679349098073, 1923114751136460212, 440770511502372502, 4134483883707043431, 2506428789614300520, 3546362436556191123, 3497886265811279489, 932522976137894852, 5443410947940562661, 7395179419574312861, 1925597547461550297, 3083566288934567853, 6391724655495198176, 8164844593195065182, 2909857915875545973, 1053375534840206791, 1296244821721594611, 263126646077365181, 3777884168630782348, 1152166463363885612, 9217013729487695673, 1775948033234846362] :: V.Vector Int
blackPawnZobristSquares :: V.Vector Int
blackPawnZobristSquares = V.fromList [5691615292360083080, 762190898621373795, 5821639506728817460, 1738661259230741628, 3019431854270606861, 83552056897441975, 6609846280203152870, 435371541937689352, 2282570952197666100, 595876304234693565, 9147403099394789001, 7533035522525488026, 5691934491529333253, 2980086244887624376, 8013905283156048390, 363527508688688673, 7374259252667187068, 362681824165828228, 4847910485499809639, 2253055107480512507, 111529475954971157, 4278544012352367756, 2766192083051374023, 7516265602420957726, 5014460317765925511, 659359411695663573, 5386737622117173576, 1038915006615490181, 7919396185844987858, 1172731710242206002, 7494156588627708487, 6160424331092024832, 4326581697273687236, 7014216158415520524, 5574249326673472790, 1730768916092988523, 1445837622325011940, 3821127040008388125, 1111961441971770546, 1611143702751896527, 6396075583328649777, 7218836424211858955, 1793189800360944425, 7339153043257517224, 6738837834036705714, 3372066062997567342, 7042377330485208733, 5844450985688756751, 3227307292985264729, 5166434995508659230, 4407216685436238279, 785947468814544316, 5494797069623248625, 9064334486126848534, 862322936918398010, 5073869142572136099, 14625017500494987, 6176046267152986925, 2976819429600612209, 4310591706489711250, 6681320062885496862, 8989889258273935260, 3722163576311367700, 1805927480862668597] :: V.Vector Int
blackKnightZobristSquares :: V.Vector Int
blackKnightZobristSquares = V.fromList [1403565454462916255, 9218273974760043426, 6983677847517772240, 7331591968540275878, 4094079603891112668, 3645458482569787123, 5885980300442319723, 3876507597005764248, 6234295781416942034, 3610081461213122612, 1773637784319159881, 7172009397515594175, 8272488767347050677, 3757391311643631956, 8704162202920884023, 8839713473012409630, 3305289356052602520, 4395246859341533893, 4853354755476472394, 6088014623487808889, 8527577002770203673, 4619286165257909464, 5197689722597111352, 1424875007737058133, 1071196320061364944, 8209690818139668736, 3965369329144655185, 5944407338050120738, 1061778754555020954, 7886209233372012600, 5092299202595764466, 7140620755769072024, 8826446383409644231, 2139401308830923225, 6628160763980947324, 1289382631800531686, 4910706469776067051, 6714723210355708126, 6576358097832606283, 2087337905894618112, 2228344893847779585, 5204208396506408030, 8019687633900796640, 2927389921365747343, 6979770986371552658, 710955057447159835, 1246835428103661368, 4288239899209224309, 414649854433031187, 3098469592891386876, 5644636714708657522, 8397734769590269397, 7561745469996983081, 6916035008389787065, 6700392039785659203, 8055163598027508892, 3826991975611290873, 4673557597793689875, 7034777241825369919, 4770906406929878243, 1061103761288165190, 7135194294936601439, 7406295689631352094, 1113272196100689149] :: V.Vector Int
blackBishopZobristSquares :: V.Vector Int
blackBishopZobristSquares = V.fromList [1966450248190379088, 2993865635034902059, 8788203921705410991, 9168583593820377450, 1237464767808744413, 1776894105739964056, 5473776405481206593, 3108517860177137431, 5682329741821421590, 9183530200379101140, 3797186426917148354, 1931394037295312024, 2148957555106458413, 8223722867305992927, 1527282297679490533, 5686607043513838725, 3119975448559538420, 8971725973451123922, 4670712296639275156, 7952526744630924527, 8112254140019974140, 1098180819886001975, 2195958098201965283, 146480965931442822, 1000133041828712324, 8859715321010272914, 7713927785108031934, 4664478895417600120, 323237241289302876, 2029739124449746224, 5314045977537512672, 7761665812734607116, 7389606616456274226, 5853730557960210518, 6405457160064940081, 7643336737387839820, 801209189917229092, 4227962273868069596, 3067822289957023955, 133447937448989907, 7326153904809858610, 3347788873011704914, 2542198793675049436, 3933137803842118338, 4740396057898551661, 8202669349863677922, 7840482582246345144, 1176356952632570992, 5769590063640359052, 8782901109905408165, 329571181494047202, 3879829922156060555, 962783806119609348, 6701909345750326547, 1879670639718369096, 6664022440892888548, 5701413165223646902, 418569841824620243, 3586682514319447750, 1154800286085849790, 3158280596792866687, 3691038129842476001, 3264887083481036557, 8923601683697323768] :: V.Vector Int
blackQueenZobristSquares :: V.Vector Int
blackQueenZobristSquares = V.fromList [4978977443718634328, 7288401877211219539, 507448495946020687, 261342561650965313, 9103401774020839501, 2811272625307151485, 6136143827755009479, 2513761986502584347, 2618037343322452944, 5139270459733357277, 6838266761075862697, 5792000861464993307, 797495321118367286, 1689440298187033107, 7742957107729489807, 108982139420953125, 1368770425759240784, 8975818365220101167, 5171348940803071326, 7429096152147114621, 8439122944226245896, 8969861888678684724, 4496306846960821643, 1249649415168978015, 7224215098383632731, 7234204955776561756, 1908939853186866432, 4613046688406647723, 979409278753174233, 5314833019430831516, 6320929885571283525, 4506518407239481613, 9191767324412116007, 534728121186412623, 4589263512943122260, 7595055229592911986, 4136038448724948633, 666042454987324494, 559356573438353282, 2497096404016838989, 876772448588838374, 2334172993029750454, 478558549750751171, 5692644283346631657, 1608177764376920769, 8203657446035958755, 3560658139861536498, 7969854509332728097, 766225182024402454, 7230810442083413000, 3409645618456651471, 8747460773660686810, 1156376364374428434, 259907978959573025, 1134256150512529358, 9191467588711542031, 3144543534942117624, 4615473031590185602, 1021874242214398643, 507301541282945445, 3340389840876346908, 814010765659554563, 8230058377636026554, 8338979323633225138] :: V.Vector Int
blackRookZobristSquares :: V.Vector Int
blackRookZobristSquares = V.fromList [1918666253752120829, 5123785239787297170, 8260467834230340948, 720956868684585182, 2625801173904837038, 3442049256491471718, 2924963729754111467, 2932143463216750042, 4141774046760525340, 7124333084796562409, 4583803384565297833, 540105885968327263, 6534998781351102301, 7603388969104123373, 1357367707300989722, 451936749081903360, 360461024317963340, 5525004701282371602, 8202188898962120645, 2226657532892967402, 4613010720567674697, 7359905980603219269, 6826810207863871489, 3894350494685017003, 6695962586797368461, 8016002439923018986, 7917644687140354836, 7843954652503033120, 6483045143331120470, 3771306383775362797, 8623750330209127396, 2900091261158332736, 5663671944283168781, 7446022214448060918, 3567290127817993180, 6013836022251678654, 489903320583615529, 2213753398843631372, 785546206712758176, 8097177210502977517, 6939208963085844221, 6469328468874844424, 672985058695375740, 4161058687295838148, 7941065023635809346, 6151778816897791754, 9013150994096788929, 2576155270622500110, 5189079453494188777, 7178303791130062751, 4730696639737107366, 6497451371231361292, 3305587776220532337, 5299835837372005486, 4399911704324168620, 4565360990101716732, 7837932032562291850, 7356609075281478700, 2671276588638382746, 4284991231858828143, 8609346109930705370, 3737809786861683657, 7460576325325589108, 76027739059752509] :: V.Vector Int
blackKingZobristSquares :: V.Vector Int
blackKingZobristSquares = V.fromList [9208188818834422943, 5079652584320734989, 5625753500461165109, 2522764131739476098, 922397543745308399, 1849530567864289883, 3565871539435181739, 8501945789448278742, 2834020835440806116, 2114898699739419510, 8156849327267637025, 7417872299570049773, 760442579520793625, 8125352974898441086, 7372747514993796401, 4820007705677169948, 5094849792765808884, 8654594184840000990, 1043002158891838519, 30069737146852339, 7480840281579044543, 5617509422479735054, 8087298089913277531, 2732971805427057233, 2139833233488709521, 4021782638741383288, 8661487598710505540, 4811833499348751086, 6129950681643071213, 4462470102654327859, 5370869476704701078, 2247623128255100219, 6095943374180634947, 4932188522700420147, 4913325323529309583, 3493168178410901252, 3408574234029055147, 1781269879077519466, 6009011768553083766, 7359460891617983503, 4078903063976677065, 1891844119477713966, 3111342753299638506, 8498343264139653994, 8554521356288376209, 8647006971813776110, 1405867315492784046, 3261249132213245190, 4172321625119480057, 1422367203506234086, 6260367524173538434, 608749605062299397, 2045889148659716268, 2122806103854230142, 8839124020569954204, 8418931016733783342, 5466714312773596092, 2059608657860469959, 1622528598239002687, 228144609206946361, 5588235677104977126, 3157823198315106642, 1729483203816602699, 3116580019810902115] :: V.Vector Int
whiteMoveZobristValue :: Int
whiteMoveZobristValue = 6612194290785701391
blackMoverZobristValue :: Int
blackMoverZobristValue = 7796428774704130372
enPassantZobristValue :: Int
enPassantZobristValue = 6687912736785776762

zobrist :: Position -> Int
zobrist p = if enPassantSquare p == 0 then z else xor z enPassantZobristValue
    where z = zobristRecur p 0 startZobristValue `xor` (if mover p == White then whiteMoveZobristValue else blackMoverZobristValue)

zobristRecur :: Position -> Int -> Int -> Int
zobristRecur _ 64 result = result
zobristRecur p square result
    | isNothing piece = zobristRecur p sp1 result
    | piece == Just (White,Pawn) = zobristRecur p sp1 (xor result (whitePawnZobristSquares V.! square))
    | piece == Just (White,Knight) = zobristRecur p sp1 (xor result (whiteKnightZobristSquares V.! square))
    | piece == Just (White,Bishop) = zobristRecur p sp1 (xor result (whiteBishopZobristSquares V.! square))
    | piece == Just (White,Rook) = zobristRecur p sp1 (xor result (whiteRookZobristSquares V.! square))
    | piece == Just (White,Queen) = zobristRecur p sp1 (xor result (whiteQueenZobristSquares V.! square))
    | piece == Just (White,King) = zobristRecur p sp1 (xor result (whiteKingZobristSquares V.! square))
    | piece == Just (Black,Pawn) = zobristRecur p sp1 (xor result (blackPawnZobristSquares V.! square))
    | piece == Just (Black,Knight) = zobristRecur p sp1 (xor result (blackKnightZobristSquares V.! square))
    | piece == Just (Black,Bishop) = zobristRecur p sp1 (xor result (blackBishopZobristSquares V.! square))
    | piece == Just (Black,Rook) = zobristRecur p sp1 (xor result (blackRookZobristSquares V.! square))
    | piece == Just (Black,Queen) = zobristRecur p sp1 (xor result (blackQueenZobristSquares V.! square))
    | piece == Just (Black,King) = zobristRecur p sp1 (xor result (blackKingZobristSquares V.! square))
    where piece = pieceOnSquare p square
          sp1 = square + 1

hashIndex :: Position -> Int
hashIndex position = mod (zobrist position) 42949672000
